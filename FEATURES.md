# 功能清單與使用指南

## 📋 功能總覽

### 1️⃣ 帳號管理

- ✅ 新增 LINE 官方帳號
  - 輸入帳號名稱與 Channel Access Token
  - 自動驗證 Token 有效性（呼叫 LINE API）
  - Token 加密儲存於伺服器資料庫
- ✅ 列出所有帳號
- ✅ 刪除帳號（CASCADE 刪除相關專案）
- ✅ 切換帳號

### 2️⃣ 專案管理

- ✅ 建立新專案
  - 專案名稱唯一性檢查（同一帳號內）
  - 支援 1-64 字名稱
  - 允許中英文、數字、空白與 `-` `_` `.`
- ✅ 列出帳號下所有專案
  - 顯示 Rich Menu 數量
  - 顯示最後更新時間
- ✅ 編輯專案
  - 更新專案名稱
  - 管理專案內的 Rich Menu
- ✅ 刪除專案

### 3️⃣ Rich Menu 編輯

#### 基本功能
- ✅ 圖片上傳
  - 支援 PNG/JPEG 格式
  - 驗證尺寸（2500×1686、2500×843 或 1200×810）
  - 自動生成縮圖（400px 寬）
- ✅ 可點擊區域管理
  - 滑鼠拖拉建立新區域
  - 拖動調整區域位置
  - 8 個控點調整區域大小
  - 刪除區域
- ✅ 動作設定
  - URI（開啟連結/撥打電話）
  - Message（傳送訊息）
  - Postback（回傳資料）
  - RichMenuSwitch（切換選單）
- ✅ Metadata 設定
  - Chat Bar 文字（1-14 字，即時計數）
  - 選單名稱
  - Alias（別名）
- ✅ JSON 即時預覽

#### 多選單管理
- ✅ Tab 分頁編輯
  - 新增多個 Rich Menu
  - 快速切換編輯
  - 複製 Rich Menu
  - 刪除 Rich Menu
- ✅ 專案設定
  - 更新專案名稱
  - 刪除整個專案
  - 管理 Rich Menu 設定

### 4️⃣ 上傳與發布

#### 上傳選項
- ✅ 僅上傳當前 Rich Menu
- ✅ 上傳專案內所有 Rich Menu
  - 自動刪除 LINE 端同名選單
  - 依序建立 metadata
  - 上傳圖片（JPEG 壓縮，最大 4.5MB）
  - 同步 Alias

#### 發布選項
- ✅ 設為預設選單（傳給所有人）
- ✅ 綁定特定使用者
  - 支援多位使用者（每行一個 User ID）
  - 解除特定使用者綁定

#### 遠端管理
- ✅ 取得 richMenuId（從 LINE 伺服器查詢）
- ✅ 取消預設選單
- ✅ 刪除遠端 Rich Menu
- ✅ Alias 管理（建立、更新、刪除）

### 5️⃣ 多人即時協作 ⭐

#### Socket.IO 實現
- ✅ 自動連線與房間管理
  - 進入專案自動加入 Socket.IO 房間
  - 離開專案自動退出房間
  - 斷線自動重連

#### 即時同步
- ✅ 使用者上線/下線通知
- ✅ 游標即時同步
  - 顯示其他使用者的游標位置
  - 彩色游標指標
  - 使用者名稱標籤
  - 平滑動畫效果
- ✅ 編輯事件廣播
  - Rich Menu 區域變更
  - Metadata 更新
  - 新增/刪除 Rich Menu

### 6️⃣ 安全性

#### IP 白名單
- ✅ 設定允許存取的 IP 位址
- ✅ 支援 114.33.21.210
- ✅ 從 NGINX X-Real-IP header 取得真實 IP
- ✅ 可選擇性啟用（開發/生產環境）

#### 資料加密
- ✅ Channel Access Token 加密儲存
  - 使用 Fernet 對稱加密
  - 金鑰保存於 `.encryption_key`
  - 自動生成金鑰

#### LINE Login（預留）
- ✅ 驗證 API 端點配置
- ✅ 員工身分驗證函式
- ✅ Request header 驗證機制

### 7️⃣ 資料持久化

#### SQLite 資料庫
- ✅ 5 張資料表設計
  - accounts：帳號與 Token
  - projects：專案資訊
  - rich_menus：Rich Menu 資料
  - aliases：Alias 管理
  - images：圖片元數據
- ✅ 外鍵約束與 CASCADE 刪除
- ✅ 索引優化查詢效能

#### 圖片儲存
- ✅ 原圖保存（uploads/）
- ✅ 縮圖生成（400px 寬）
- ✅ 檔案名稱安全處理
- ✅ 支援 PNG/JPEG

### 8️⃣ API 設計

#### REST API (`/api`)
- ✅ RESTful 設計風格
- ✅ JSON 回應格式統一
- ✅ 錯誤訊息清晰
- ✅ CORS 支援

#### LINE API 代理 (`/proxy`)
- ✅ 完整的 LINE Messaging API 代理
- ✅ 自動轉送 Authorization header
- ✅ 處理 api.line.me 與 api-data.line.me
- ✅ 二進位圖片上傳支援

## 🎯 使用流程

### 基本流程（4 步驟）

#### 步驟 1：選擇官方帳號
1. 點擊「新增帳號」
2. 輸入帳號名稱（例如：測試帳號）
3. 輸入 Channel Access Token
4. 系統自動驗證 Token
5. 驗證成功後保存

#### 步驟 2：建立或選擇專案
1. 選擇已建立的專案，或
2. 點擊「新增專案」建立新專案
3. 輸入專案名稱（同一帳號內需唯一）
4. 進入專案編輯頁面

#### 步驟 3：編輯 Rich Menu
1. 上傳圖片（2500×1686 或 2500×843）
2. 在畫布上建立可點擊區域
   - 滑鼠拖拉建立矩形
   - 拖動調整位置
   - 8 個控點調整大小
3. 為每個區域設定動作
   - URI：輸入網址或 `tel:0912345678`
   - Message：輸入訊息文字
   - Postback：輸入 data payload
   - RichMenuSwitch：選擇目標選單
4. 設定 Chat Bar 文字（1-14 字）
5. 設定 Alias（用於選單切換）
6. 查看 JSON 預覽

#### 步驟 4：上傳與發布
1. 點擊「上傳發布」
2. 選擇上傳範圍
   - 僅當前 Rich Menu
   - 專案內所有 Rich Menu
3. 選擇發布目標
   - 設為預設（所有人）
   - 綁定特定使用者（輸入 User ID）
4. 點擊「開始上傳」
5. 等待上傳完成

### 多人協作流程

#### 邀請協作者
1. 提供專案網址：`https://line-setting.wentzao.com`
2. 協作者需要在允許的 IP 範圍內（或設定 LINE Login）
3. 選擇相同的帳號與專案

#### 協作中
- ✅ 可看到其他人的游標
- ✅ 即時看到其他人的編輯
- ✅ 自動同步變更
- ⚠️ 避免同時編輯同一 Rich Menu（目前無鎖定機制）

## 🔧 進階功能

### Alias 與選單切換

1. 為每個 Rich Menu 設定 Alias
   - 例如：`menu_main`、`menu_products`、`menu_support`
2. 在區域動作選擇「切換選單」
3. 選擇目標 Alias
4. 上傳後自動同步到 LINE

### 取得 richMenuId

1. 開啟「設定」
2. 選擇 Rich Menu 分頁
3. 點擊「取得 richMenuId」
4. 系統從 LINE 伺服器查詢並填入

### 刪除遠端 Rich Menu

1. 開啟「設定」
2. 選擇 Rich Menu 分頁
3. 點擊「刪除遠端」
4. 確認後刪除 LINE 端的 Rich Menu

## 📊 技術限制

### LINE API 限制
- Rich Menu 圖片：最大 1MB
- Rich Menu 尺寸：2500×1686 或 2500×843
- Chat Bar 文字：1-14 字
- 每個帳號最多 1000 個 Rich Menu
- Alias：需符合 LINE 命名規範

### 應用限制
- 單伺服器部署（擴展需要 Redis）
- 圖片儲存於本地檔案系統
- SQLite 資料庫（適合中小型使用）

## 🎨 UI/UX 特色

### 視覺設計
- 主色：`#02a568`（LINE 綠）
- 卡片式介面
- Pill 風格分頁
- 懸浮工具列
- 毛玻璃效果

### 互動體驗
- 拖拉建立區域
- 8 控點精確調整
- 即時 JSON 預覽
- 字數即時計數
- 自動儲存（800ms 延遲）

### 多人協作視覺
- 彩色游標指標
- 使用者名稱標籤
- 平滑動畫
- 上線/下線通知

## 💡 使用建議

### 最佳實踐
1. 為專案取有意義的名稱
2. 為 Rich Menu 設定 Alias（便於切換）
3. 定期備份資料庫
4. 在測試環境先驗證後再上傳到正式環境
5. 使用「取得 richMenuId」追蹤已上傳的選單

### 協作建議
1. 建立專案前先溝通分工
2. 避免同時編輯同一 Rich Menu
3. 善用 Chat 或語音溝通（應用外）
4. 定期同步進度

### 安全建議
1. 不要將 Channel Access Token 分享給他人
2. 定期更換 Token
3. 啟用 IP 白名單
4. 使用 HTTPS
5. 定期備份資料

## 🔜 未來功能規劃

- [ ] 編輯衝突偵測與解決
- [ ] Rich Menu 鎖定機制
- [ ] 歷史版本與回溯
- [ ] 匯出/匯入專案
- [ ] 範本市集
- [ ] 使用者權限管理
- [ ] 內建聊天室
- [ ] 圖片編輯器整合
- [ ] 批次操作
- [ ] 進階統計分析

---

**提示**：如需更多技術細節，請參閱 `README.md` 與 `DEPLOYMENT.md`

